#!/usr/bin/env groovy

@Library("jenkins-shared-libraries") _

pipeline {
    options {
        buildDiscarder(logRotator(numToKeepStr: '5', artifactNumToKeepStr: '5'))
        disableConcurrentBuilds()
        parallelsAlwaysFailFast()
    }
    parameters {
        booleanParam(name: 'DEBUG_BUILD', defaultValue: true, description: 'if true, never release')
    }
    triggers {
        cron('H H(20-21) * * *')
    }
    environment {
        // application settings
        APP_NAME = "jenkins-pipeline"
        VERSION = "1.0.2"
        FULL_VERSION = "${VERSION}.${BUILD_ID}"
        IMAGE_NAME = "${DOCKER_REGISTRY_CRED_USR}/${APP_NAME}"
        CSPROJECT_NAME = "Doggy.API.WebService"

        // docker credentials
        DOCKER_REGISTRY_URL = "https://registry.hub.docker.com/"
        DOCKER_REGISTRY_ID = "docker-hub-credential"
        DOCKER_REGISTRY_CRED = credentials("${DOCKER_REGISTRY_ID}")

        // sonarqube settings
        SONARQUBE_HOST_URL = "https://sonar.blackhorseya.com"
        SONARQUBE_TOKEN = credentials('sonarqube-token')

        // kubernetes settings
        KUBE_CONFIG_ID = "kube-config"

        // git settings
        GIT_CREDENTIAL_ID = "github-ssh"
    }
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: builder
    image: blackhorseya/dotnet-builder:3.1-alpine
    command: ['cat']
    tty: true
  - name: docker
    image: docker:latest
    command: ['cat']
    tty: true
    volumeMounts:
    - name: dockersock
      mountPath: /var/run/docker.sock
  - name: helm
    image: alpine/helm:3.1.0
    command: ['cat']
    tty: true
  volumes:
  - name: dockersock
    hostPath:
      path: /var/run/docker.sock
"""
        }
    }
    stages {
        stage('Prepare') {
            steps {
                script {
                    def causes = currentBuild.getBuildCauses()
                    echo "causes: ${causes}"

                    def commitChangeset = sh(returnStdout: true, script: 'git diff-tree --no-commit-id --name-status -r HEAD').trim()
                    echo "changeset: ${commitChangeset}"
                    
                    DEPLOY_TO = common.getTargetEnv("${GIT_BRANCH}")
                }

                echo """
branch name: ${env.GIT_BRANCH}
target env: ${DEPLOY_TO}
"""
                sh label: "print all environment variable", script: "printenv | sort"

                container('builder') {
                    script {
                        dotnet.printInfo()
                    }
                }

                container('docker') {
                    sh label: "print docker info and version", script: """
                    docker info
                    docker version
                    """
                }

                container('helm') {
                    script {
                        deploy.helmInfo()
                        deploy.copyConfig("${KUBE_CONFIG_ID}")
                    }
                }
            }
        }

        stage('Build') {
            steps {
                container('builder') {
                    script {
                        dotnet.build(useCache: true)
                    }
                }
            }
        }

        stage('Test') {
            parallel {
                stage('Unit Test') {
                    steps {
                        container('builder') {
                            script {
                                dotnet.test(
                                    genCoverage: true,
                                    genReport: true
                                )
                            }
                        }
                    }
                }
                stage('Regression Test') {
                    when {
                        triggeredBy cause: "UserIdCause"
                    }
                    steps {
                        container('builder') {
                            // script {
                            //     error("throw regression failed")
                            // }
                            echo "regression test success"
                        }
                    }
                }
            }
        }

        stage('Static Code Analysis') {
            when {
                anyOf {
                    allOf {
                        branch 'develop'
                        triggeredBy 'TimerTrigger'
                    }
                    allOf {
                        triggeredBy cause: "UserIdCause"
                    }
                }
            }
            steps {
                echo "static code analysis"
            }
        }

        stage('Build and push docker image') {
            when {
                anyOf {
                    allOf {
                        branch 'develop'
                        triggeredBy 'TimerTrigger'
                    }
                    allOf {
                        triggeredBy cause: "UserIdCause"
                    }
                    allOf {
                        tag pattern: "\\d+\\.\\d+\\.\\d+", comparator: "REGEXP"
                        buildingTag()
                    }
                }
            }
            steps {
                container('docker') {
                    script {
                        docker.withRegistry("${DOCKER_REGISTRY_URL}", "${DOCKER_REGISTRY_ID}") {
                            def image = docker.build("${IMAGE_NAME}:${FULL_VERSION}", "--network host --build-arg CSPROJECT_NAME=${CSPROJECT_NAME} .")
                            image.push()
                            image.push('latest')
                        }
                    }
                }
            }
        }

        stage("Deploy") {
            when {
                anyOf {
                    allOf {
                        branch 'develop'
                        triggeredBy 'TimerTrigger'
                    }
                    allOf {
                        triggeredBy cause: "UserIdCause"
                    }
                    allOf {
                        tag pattern: "\\d+\\.\\d+\\.\\d+", comparator: "REGEXP"
                        buildingTag()
                    }
                }
            }
            steps {
                echo "deploy to ${DEPLOY_TO}"

                sshagent(["${GIT_CREDENTIAL_ID}"]) {
                    sh label: "git tag latest", script: """
                    git tag --delete latest | exit 0 && git push --delete origin latest | exit 0
                    git tag latest && git push --tags
                    """
                }
            }
        }

        stage("Create Release") {
            when {
                tag pattern: "\\d+\\.\\d+\\.\\d+", comparator: "REGEXP"
                buildingTag()
                expression { return !params.DEBUG_BUILD } 
            }
            steps {
                echo "create release"

                sshagent(["${GIT_CREDENTIAL_ID}"]) {
                    sh label: "git tag release-${FULL_VERSION}", script: """
                    git tag --delete ${TAG_NAME} | exit 0 && git push --delete origin ${TAG_NAME} | exit 0
                    git tag release-${FULL_VERSION} && git push --tags
                    """
                }
            }
        }
    }

    post {
        always {
            script {
                notify.sendSlack()
            }
        }
    }
}
